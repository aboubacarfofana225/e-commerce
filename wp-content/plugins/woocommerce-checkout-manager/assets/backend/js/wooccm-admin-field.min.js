(function(f){var h=0,b;var e=function(m){return m.is(".processing")||m.parents(".processing").length};var d=function(){f("#wooccm_modal").addClass("processing")};var g=function(){f("#wooccm_modal").removeClass("processing")};_.mixin({sortOptions:function(m){return _.sortBy(m,function(n){return n.order})}});var c=Backbone.View.extend({templates:{},initialize:function(){this.templates.window=wp.template("wooccm-modal-tabs")},render:function(){this.model.attributes.panel="general";this.$el.html(this.templates.window(this.model.attributes))}});var l=Backbone.View.extend({templates:{},initialize:function(){this.templates.window=wp.template("wooccm-modal-panels")},render:function(){this.$el.html(this.templates.window(this.model.attributes));this.$el.trigger("wooccm-enhanced-options");this.$el.trigger("wooccm-enhanced-select");this.$el.trigger("init_tooltips")}});var k=Backbone.View.extend({templates:{},initialize:function(){this.templates.window=wp.template("wooccm-modal-info")},render:function(){this.$el.html(this.templates.window(this.model.attributes));this.$el.trigger("wooccm-enhanced-select");this.$el.trigger("init_tooltips")}});var j=Backbone.View.extend({events:{"change input":"enableSave","change textarea":"enableSave","change select":"enableSave","click .media-modal-backdrop":"close","click .media-modal-close":"close","click .media-modal-prev":"edit","click .media-modal-next":"edit","click .media-modal-tab":"tab","change .media-modal-parent":"parent","change .media-modal-render-tabs":"renderTabs","change .media-modal-render-panels":"renderPanels","change .media-modal-render-info":"renderInfo","submit .media-modal-form":"submit",},templates:{},initialize:function(){_.bindAll(this,"tab","open","edit","parent","load","render","close","submit");this.init();this.open()},init:function(){this.templates.window=wp.template("wooccm-modal-main")},assign:function(n,m){n.setElement(this.$(m)).render()},render:function(){var m=this;m.$el.html(m.templates.window(m.model.attributes));this.tabs=new c({model:m.model});this.panels=new l({model:m.model});this.info=new k({model:m.model});this.assign(this.tabs,"#wooccm-modal-tabs");this.assign(this.panels,"#wooccm-modal-panels");this.assign(this.info,"#wooccm-modal-info")},load:function(){var m=this;d();f.ajax({url:wooccm_field.ajax_url,data:{action:"wooccm_load_field",nonce:wooccm_field.nonce,field_id:this.model.attributes.id},dataType:"json",type:"POST",beforeSend:function(){},complete:function(){g()},error:function(){alert("Error!")},success:function(n){if(n.success){m.model.set(n.data);m.render()}else{alert(n.data)}}})},edit:function(q){q.preventDefault();var o=this,p=f(q.target),n=parseInt(f(".wc_gateways tr[data-field_id]").length),m=parseInt(o.model.get("order"));h++;if(b){clearTimeout(b)}b=setTimeout(function(){if(p.hasClass("media-modal-next")){m=Math.min(m+h,n)}else{m=Math.max(m-h,1)}o.model.set({id:parseInt(f(".wc_gateways tr[data-field_order="+m+"]").data("field_id"))});h=0;o.load()},300)},open:function(m){f("body").addClass("modal-open").append(this.$el);if(this.model.attributes.id==undefined){_.delay(function(){g()},100);return}this.load()},updateModel:function(p){p.preventDefault();var n=f(p.target),m=n.attr("name"),o=n.val();if(p.target.type==="checkbox"){o=n.prop("checked")===true?1:0}this.model.attributes[m]=o;this.model.changed[m]=o},tab:function(r){r.preventDefault();var p=this,o=p.$el.find("#wooccm_modal"),q=f(r.currentTarget),m=o.find("ul.wc-tabs"),n=q.find("a").attr("href").replace("#","");m.find(".active").removeClass("active");q.addClass("active");this.model.attributes.panel=n;this.model.changed.panel=n;this.renderPanels(r)},renderTabs:function(m){this.renderPanels(m);this.tabs.render()},renderPanels:function(m){this.updateModel(m);this.panels.render()},renderInfo:function(){this.info.render()},close:function(m){m.preventDefault();this.undelegateEvents();f(document).off("focusin");f("body").removeClass("modal-open");this.remove()},parent:function(p){p.preventDefault();var o=this,n=o.$el.find("#wooccm_modal"),m=n.find(".attachment-details");this.updateModel(p);f.ajax({url:wooccm_field.ajax_url,data:{action:"wooccm_load_parent",nonce:wooccm_field.nonce,conditional_parent_key:o.model.attributes.conditional_parent_key},dataType:"json",type:"POST",beforeSend:function(){o.disableSave();m.addClass("save-waiting")},complete:function(){m.addClass("save-complete");m.removeClass("save-waiting");o.enableSave()},error:function(){alert("Error!")},success:function(q){if(q.success){o.model.attributes.parent=q.data;o.model.changed.parent=q.data;o.renderInfo()}else{alert(q.data)}}});return false},reload:function(m){if(this.$el.find("#wooccm_modal").hasClass("reload")){location.reload();return}this.remove();return},close:function(m){m.preventDefault();this.undelegateEvents();f(document).off("focusin");f("body").removeClass("modal-open");this.reload(m);return},enableSave:function(m){f(".media-modal-submit").removeProp("disabled")},disableSave:function(m){f(".media-modal-submit").prop("disabled",true)},submit:function(p){p.preventDefault();var o=this,n=o.$el.find("#wooccm_modal"),m=n.find(".attachment-details");f.ajax({url:wooccm_field.ajax_url,data:{action:"wooccm_save_field",nonce:wooccm_field.nonce,field_id:o.model.attributes.id,field_data:f("form",this.$el).serialize()},dataType:"json",type:"POST",beforeSend:function(){f(".media-modal-submit").prop("disabled",true);m.addClass("save-waiting");d()},complete:function(){m.addClass("save-complete");m.removeClass("save-waiting");g()},error:function(){alert("Error!")},success:function(q){if(q.success){if(o.model.attributes.id==undefined){n.addClass("reload");o.close(p)}o.model.set(q.data)}else{alert(q.data)}}});return false}});var i=Backbone.Model.extend({defaults:wooccm_field.args});var a=Backbone.View.extend({initialize:function(p){var o=f(p.target),n=o.closest("[data-field_id]").data("field_id");var m=new i();m.set({id:n});new j({model:m}).render()},});f("#wooccm_billing_settings_add, #wooccm_shipping_settings_add, #wooccm_additional_settings_add").on("click",function(m){m.preventDefault();new a(m)});f("#wooccm_billing_settings_reset, #wooccm_shipping_settings_reset, #wooccm_additional_settings_reset").on("click",function(n){n.preventDefault();var m=f(n.target);var o=confirm(wooccm_field.message.reset);if(!o){return false}f.ajax({url:wooccm_field.ajax_url,data:{action:"wooccm_reset_fields",nonce:wooccm_field.nonce},dataType:"json",type:"POST",beforeSend:function(){},complete:function(){},error:function(){alert("Error!")},success:function(p){if(p.success){location.reload()}else{alert(p.data)}}});return false});f(".wooccm_billing_settings_edit, .wooccm_shipping_settings_edit, .wooccm_additional_settings_edit").on("click",function(m){m.preventDefault();new a(m)});f(".wooccm_billing_settings_delete, .wooccm_shipping_settings_delete, .wooccm_additional_settings_delete").on("click",function(p){p.preventDefault();var o=f(p.target),n=o.closest("[data-field_id]"),m=n.data("field_id");var q=confirm(wooccm_field.message.remove);if(!q){return false}f.ajax({url:wooccm_field.ajax_url,data:{action:"wooccm_delete_field",nonce:wooccm_field.nonce,field_id:m,},dataType:"json",type:"POST",beforeSend:function(){},complete:function(){},error:function(){alert("Error!")},success:function(r){if(r.success){n.remove()}else{alert(r.data)}}});return false});f(document).on("click",".wooccm-field-toggle-attribute",function(p){p.preventDefault();var m=f(this),o=m.closest("tr"),n=m.find(".woocommerce-input-toggle");f.ajax({url:wooccm_field.ajax_url,data:{action:"wooccm_toggle_field_attribute",nonce:wooccm_field.nonce,field_attr:f(this).data("field_attr"),field_id:o.data("field_id")},dataType:"json",type:"POST",beforeSend:function(q){n.addClass("woocommerce-input-toggle--loading")},success:function(q){if(true===q.data){n.removeClass("woocommerce-input-toggle--enabled, woocommerce-input-toggle--disabled");n.addClass("woocommerce-input-toggle--enabled");n.removeClass("woocommerce-input-toggle--loading")}else{if(true!==q.data){n.removeClass("woocommerce-input-toggle--enabled, woocommerce-input-toggle--disabled");n.addClass("woocommerce-input-toggle--disabled");n.removeClass("woocommerce-input-toggle--loading")}}}});return false});f(document).on("change",".wooccm-field-change-attribute",function(o){o.preventDefault();var m=f(this),n=m.closest("tr");f.ajax({url:wooccm_field.ajax_url,data:{action:"wooccm_change_field_attribute",nonce:wooccm_field.nonce,field_attr:m.data("field_attr"),field_value:m.val(),field_id:n.data("field_id"),},dataType:"json",type:"POST",beforeSend:function(p){m.prop("disabled",true)},success:function(p){console.log(p.data)},complete:function(p){m.prop("disabled",false)},});return false})})(jQuery);